{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}


{% block title %}
Request Allocation Change
{% endblock %}


{% block content %}

<h2>Request change to {{ allocation.get_parent_resource }} for project: {{ allocation.project.title }}</h2>
<hr>

<p class="text-justify">
  Request changes to an existing allocation using the form below. You must provide a reason for each change.
</p>

<form action="{% url 'allocation-change' allocation.pk %}" method="post">
    {% csrf_token %}
  <div class="card mb-3">

    <div class="card-body">

          <div>
            <p>Pending changes:</p>
          <ul>
            {% for change in allocation.allocationchangerequest_set.all %}
              {% if change.status.name == "Pending" %}
              <li><a href="{% url 'allocation-change-detail' change.pk %}">{{ change.created|date:"M. d, Y" }} - {{ change.allocationattributechangerequest_set.first.allocation_attribute.attribute_type.name }}</a></li>
              {% endif %}
            {% endfor %}
          </ul>
          </div>
  {% if formset %}
        
          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th scope="col"><span class="sr-only">Attribute</span></th>
                  <th scope="col">Current Value</th>
                  <th scope="col">Requested Value</th>
                </tr>
              </thead>
              <tbody>
                {% for form in formset %}
                    <tr>
                      <td>{{form.name.value}}</td>
                      <td>{{form.value.value}}
                        {% for attr in allocation.allocationattribute_set.all %}
                          {% if attr.allocation_attribute_type.name == form.name.value and attr.allocationattributeusage %} ({{ attr.allocationattributeusage.value }} used){% endif %}
                        {% endfor %}
                      </td>
                      <td>{{form.new_value}}</td>
                    </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {{ formset.management_form }}
        </div>
      </div>
    {% endif %}

    <div>
      <div class="form-group">
            <label for="{{ form.justification.id_for_label }}">
                Reason for Change:
            </label>
            {{ form.justification }}
            <small class="form-text text-muted">please include some information about the reason for this request. e.g. new lab member, new data set</small>
        </div>
      <input class="btn btn-success" type="submit" value="Submit" />
      <a class="btn btn-secondary" href="{% url 'allocation-detail' allocation.pk %}" role="button">Back to
        Allocation</a><br>
    </div>
</form>

<script>
</script>
{% endblock %}
